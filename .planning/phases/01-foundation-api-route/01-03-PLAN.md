---
phase: 01-foundation-api-route
plan: 03
type: execute
wave: 3
depends_on:
  - 01-02
files_modified:
  - vercel.json
autonomous: false
requirements:
  - INFRA-05

must_haves:
  truths:
    - "App is accessible at a public Vercel URL"
    - "POST to /api/generate on the Vercel URL with a valid prompt returns a generated image"
    - "POST with empty prompt to the Vercel URL returns 400 with specific validation error"
    - "GEMINI_API_KEY is set in Vercel environment variables (not in client bundle)"
  artifacts:
    - path: "vercel.json"
      provides: "Vercel deployment configuration (if needed, otherwise optional)"
  key_links:
    - from: "Vercel deployment"
      to: "GEMINI_API_KEY"
      via: "Vercel environment variable"
      pattern: "Environment Variables in Vercel dashboard or CLI"
    - from: "Public URL /api/generate"
      to: "src/app/api/generate/route.ts"
      via: "Vercel serverless function routing"
---

<objective>
Deploy the project to Vercel and verify all Phase 1 success criteria against the production URL.

Purpose: The app must be publicly accessible (INFRA-05). Deployment also validates that the binary streaming response, timeout settings, and environment variable configuration work correctly on Vercel's infrastructure (not just locally).
Output: A live Vercel URL where the API route works end-to-end.
</objective>

<execution_context>
@/Users/nusretozturk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nusretozturk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-api-route/01-RESEARCH.md
@.planning/phases/01-foundation-api-route/01-01-SUMMARY.md
@.planning/phases/01-foundation-api-route/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy to Vercel and configure environment</name>
  <files>vercel.json</files>
  <action>
    1. **Commit all code** to git (main branch). The project must be committed before Vercel deployment.

    2. **Check if Vercel CLI is installed:**
       ```
       npx vercel --version
       ```
       If not installed or outdated, the npx command will handle it.

    3. **Deploy to Vercel:**
       ```
       npx vercel --yes
       ```
       This creates the Vercel project and deploys. Accept defaults for project name and settings.

    4. **Set the GEMINI_API_KEY environment variable on Vercel:**
       ```
       npx vercel env add GEMINI_API_KEY production
       ```
       When prompted, enter the API key value. If this requires interactive input that Claude cannot provide, create a checkpoint for the user.

       Alternative if non-interactive is needed:
       ```
       echo "$GEMINI_API_KEY" | npx vercel env add GEMINI_API_KEY production
       ```
       (reads from local .env.local)

    5. **Trigger a production deployment** (env vars only take effect on new deployments):
       ```
       npx vercel --prod --yes
       ```

    6. **Capture the production URL** from the deployment output.

    7. **Create vercel.json only if needed** (usually not required for standard Next.js). If the deployment works without it, skip this file. If function timeout needs explicit configuration, add:
       ```json
       {
         "functions": {
           "src/app/api/generate/route.ts": {
             "maxDuration": 120
           }
         }
       }
       ```
       Note: The `export const maxDuration = 120` in the route file should be sufficient. Only add vercel.json if deployment testing reveals the timeout config is not being respected.

    Note: If Vercel CLI authentication is required and Claude cannot complete it, this will be flagged as a dynamic auth gate for the user.
  </action>
  <verify>
    1. `npx vercel ls` shows the project with a production deployment.
    2. `npx vercel env ls production` shows GEMINI_API_KEY is set.
    3. Visit the production URL in a browser -- should show "Saimos Image Gen" placeholder page.
  </verify>
  <done>
    Project is deployed to Vercel. GEMINI_API_KEY is configured as a production environment variable. Production URL is accessible.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify all Phase 1 success criteria on production</name>
  <files>N/A (verification only)</files>
  <action>
    **What was built:** The complete Phase 1 foundation -- Next.js project with Gemini API proxy route deployed to Vercel. The route handles text-to-image generation, input validation, safety filter detection, and timeout handling.

    **How to verify** (test against the production Vercel URL, replace {URL} with actual deployment URL):

    1. **Valid generation request returns an image:**
       ```
       curl -X POST {URL}/api/generate \
         -H "Content-Type: application/json" \
         -d '{"prompt":"a simple red circle on white background"}' \
         --output test-production.png
       ```
       Expected: File `test-production.png` is a valid, viewable PNG image.

    2. **Empty prompt returns validation error:**
       ```
       curl -s -X POST {URL}/api/generate \
         -H "Content-Type: application/json" \
         -d '{"prompt":""}' | cat
       ```
       Expected: `{"error":"Please enter a prompt."}` with HTTP 400 (not 500).

    3. **Safety filter test (try a clearly inappropriate prompt):**
       Expected: `{"error":"The request was blocked by content safety filters. Try rephrasing your prompt."}` with HTTP 422.

    4. **API key not in client bundle:**
       Visit {URL} in browser. Open DevTools > Sources. Search all loaded JS files for "GEMINI" or "AIza" (Google API key prefix). Expected: No matches found.

    5. **App accessible at public URL:**
       Visit {URL} in browser. Expected: "Saimos Image Gen" page loads.

    **Resume signal:** Type "approved" if all 5 checks pass, or describe which checks failed.
  </action>
  <verify>User confirms all 5 Phase 1 success criteria pass against the production URL.</verify>
  <done>All Phase 1 success criteria verified on production: valid prompt returns image, empty prompt returns 400, safety filter returns 422, API key not in client bundle, app accessible at public URL.</done>
</task>

</tasks>

<verification>
All 5 Phase 1 success criteria verified against production:
1. POST with text prompt returns generated image (binary PNG)
2. Malformed/empty request returns specific validation error (not generic 500)
3. Safety-filtered prompt returns clear "try rephrasing" message
4. API key not in client-side JavaScript bundle
5. App accessible at public Vercel URL
</verification>

<success_criteria>
- App deployed and accessible at a public Vercel URL (INFRA-05)
- API route works end-to-end on production (not just locally)
- Environment variable configured correctly on Vercel
- All Phase 1 success criteria pass against the production URL
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-api-route/01-03-SUMMARY.md`
</output>
