---
phase: 02-text-to-image-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/constants.ts
  - src/lib/types.ts
  - src/app/page.tsx
  - src/components/prompt-input.tsx
autonomous: true
requirements:
  - GEN-01
  - UX-04

must_haves:
  truths:
    - "User can type a text prompt into an auto-expanding textarea"
    - "User can press a Generate button or Cmd/Ctrl+Enter to trigger generation"
    - "Pressing Generate sends a POST request to /api/generate with prompt, aspectRatio, resolution, and mode"
    - "Only the last generated image blob URL is held in state -- no persistence"
    - "Previous blob URL is revoked when a new image is generated"
    - "Rapid Generate clicks abort the previous in-flight request"
  artifacts:
    - path: "src/lib/constants.ts"
      provides: "ASPECT_RATIOS and RESOLUTIONS arrays with shape factors and cost strings"
      contains: "ASPECT_RATIOS"
    - path: "src/lib/types.ts"
      provides: "GenerateRequest interface and AspectRatio/Resolution types"
      contains: "GenerateRequest"
    - path: "src/app/page.tsx"
      provides: "Client page orchestrating all state, fetch logic, and child component rendering"
      exports: ["default"]
    - path: "src/components/prompt-input.tsx"
      provides: "Auto-expanding textarea with Cmd/Ctrl+Enter shortcut and Generate button"
      exports: ["PromptInput"]
  key_links:
    - from: "src/app/page.tsx"
      to: "/api/generate"
      via: "fetch in handleGenerate callback"
      pattern: "fetch.*api/generate"
    - from: "src/app/page.tsx"
      to: "src/components/prompt-input.tsx"
      via: "component import and rendering"
      pattern: "import.*PromptInput"
    - from: "src/app/page.tsx"
      to: "src/lib/constants.ts"
      via: "type imports for state initialization"
      pattern: "import.*constants"
---

<objective>
Build the core generation flow: the page component that orchestrates all state, the prompt input component, shared types and constants, and the fetch logic that sends requests to the Phase 1 API route. This plan creates the page with all component slots wired (FilterControls, ResultDisplay) so subsequent plans only need to create those component files without touching page.tsx.

Purpose: Establishes the data flow backbone -- every user interaction (prompt entry, filter change, generate click) flows through the page component's state and the handleGenerate callback. Plans 02-02 and 02-03 create their components to drop into the slots this plan defines.

Output: Working page with prompt input that sends generation requests to the API and displays the returned image blob URL. Filter and result components are imported but created in parallel plans.
</objective>

<execution_context>
@/Users/nusretozturk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nusretozturk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-text-to-image-generation/02-CONTEXT.md
@.planning/phases/02-text-to-image-generation/02-RESEARCH.md

# Phase 1 artifacts (assumed to exist from Phase 1 execution):
@src/app/api/generate/route.ts
@src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared constants and types</name>
  <files>src/lib/constants.ts, src/lib/types.ts</files>
  <action>
Create `src/lib/constants.ts` with:
- `ASPECT_RATIOS` array of objects: `{ value, label, widthFactor, heightFactor }` for all 8 ratios (1:1, 3:2, 2:3, 4:3, 3:4, 16:9, 9:16, 21:9). Use `as const` assertion. widthFactor/heightFactor are normalized so the smaller dimension is 1 (e.g., 16:9 -> widthFactor: 1.78, heightFactor: 1).
- `RESOLUTIONS` array of objects: `{ value, label, cost }` for 1K ($0.13), 2K ($0.13), 4K ($0.24). Use `as const` assertion.
- Export derived types: `type AspectRatio = typeof ASPECT_RATIOS[number]["value"]` and `type Resolution = typeof RESOLUTIONS[number]["value"]`.

Create `src/lib/types.ts` with:
- `GenerateRequest` interface: `{ prompt: string; aspectRatio: string; resolution: string; mode: "text-to-image" }`
- `ErrorResponse` interface: `{ error: string }`

Use exact values from research:
```typescript
export const ASPECT_RATIOS = [
  { value: "1:1",  label: "1:1",  widthFactor: 1,    heightFactor: 1 },
  { value: "3:2",  label: "3:2",  widthFactor: 1.5,  heightFactor: 1 },
  { value: "2:3",  label: "2:3",  widthFactor: 1,    heightFactor: 1.5 },
  { value: "4:3",  label: "4:3",  widthFactor: 1.33, heightFactor: 1 },
  { value: "3:4",  label: "3:4",  widthFactor: 1,    heightFactor: 1.33 },
  { value: "16:9", label: "16:9", widthFactor: 1.78, heightFactor: 1 },
  { value: "9:16", label: "9:16", widthFactor: 1,    heightFactor: 1.78 },
  { value: "21:9", label: "21:9", widthFactor: 2.33, heightFactor: 1 },
] as const;
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/lib/constants.ts src/lib/types.ts` (or run `npm run build` if available). Confirm exports are importable.</verify>
  <done>constants.ts exports ASPECT_RATIOS, RESOLUTIONS, AspectRatio type, Resolution type. types.ts exports GenerateRequest and ErrorResponse interfaces.</done>
</task>

<task type="auto">
  <name>Task 2: Create prompt input component and page orchestrator</name>
  <files>src/components/prompt-input.tsx, src/app/page.tsx</files>
  <action>
**Install react-textarea-autosize** (1.3 KB, needed for Safari support -- CSS `field-sizing: content` not supported):
```bash
npm install react-textarea-autosize
```

**Create `src/components/prompt-input.tsx`:**
- Props interface: `{ value: string; onChange: (value: string) => void; onSubmit: () => void; isLoading: boolean }`
- Named export `PromptInput` (not default export)
- Use `"use client"` directive
- Render `TextareaAutosize` from `react-textarea-autosize` with:
  - `minRows={2}`, `maxRows={6}` (per context: min ~2 lines, max ~6 lines)
  - `placeholder="Describe the image you want to create..."` (per context)
  - `resize-none` class to prevent manual resize handle
  - Focus ring styling with green accent
- `canSubmit` computed: `value.trim().length > 0 && !isLoading`
- `handleKeyDown`: Check `e.isComposing` first (IME safety per research pitfall 5). If `(e.metaKey || e.ctrlKey) && e.key === "Enter" && canSubmit`, call `e.preventDefault()` then `onSubmit()`.
- Generate button: disabled when `!canSubmit`. Shows "Generating..." text when `isLoading`, "Generate" otherwise. Green background with hover/active states.

**Create `src/app/page.tsx`:**
- `"use client"` directive (orchestrates all client state)
- Import all three child components: `PromptInput`, `FilterControls`, `ResultDisplay`. FilterControls and ResultDisplay will be created by plans 02-02 and 02-03 respectively -- for now, create minimal placeholder exports in their files so the page compiles:
  - Create `src/components/filter-controls.tsx` as a placeholder: export `FilterControls` that renders `null` (literally `export function FilterControls(props: any) { return null; }`). Plan 02-02 will replace this entirely.
  - Create `src/components/result-display.tsx` as a placeholder: export `ResultDisplay` that renders `null`. Plan 02-03 will replace this entirely.
- State hooks (all in page component):
  - `prompt` / `setPrompt` (string, default "")
  - `aspectRatio` / `setAspectRatio` (AspectRatio, default "1:1")
  - `resolution` / `setResolution` (Resolution, default "1K")
  - `imageUrl` / `setImageUrl` (string | null, default null)
  - `isLoading` / `setIsLoading` (boolean, default false)
  - `error` / `setError` (string | null, default null)
  - `abortControllerRef` (useRef<AbortController | null>(null))
- `handleGenerate` (useCallback):
  1. Abort any in-flight request: `abortControllerRef.current?.abort()`
  2. Create new AbortController, assign to ref
  3. Set `isLoading(true)`, `setError(null)`
  4. `fetch("/api/generate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ prompt, aspectRatio, resolution, mode: "text-to-image" }), signal: controller.signal })`
  5. If `!res.ok`: parse as JSON, throw `new Error(data.error || "Generation failed.")`
  6. If `res.ok`: `const blob = await res.blob()`, create object URL
  7. Revoke previous `imageUrl` if it exists: `if (imageUrl) URL.revokeObjectURL(imageUrl)`
  8. Set new `imageUrl`
  9. Catch: ignore AbortError, otherwise `setError(err.message || "Something went wrong.")`
  10. Finally: `setIsLoading(false)`
  - Dependencies: `[prompt, aspectRatio, resolution, imageUrl]`
- Render layout:
  - `<main>` wrapper with padding and max-width
  - `<PromptInput value={prompt} onChange={setPrompt} onSubmit={handleGenerate} isLoading={isLoading} />`
  - `<FilterControls aspectRatio={aspectRatio} onAspectRatioChange={setAspectRatio} resolution={resolution} onResolutionChange={setResolution} />`
  - `<ResultDisplay imageUrl={imageUrl} isLoading={isLoading} error={error} onRetry={handleGenerate} />`
  - Add `gap` spacing between sections

**Important implementation notes:**
- Do NOT use `useEffect` to trigger generation -- it is a user action, not a side effect (per research anti-pattern)
- Error responses from the API are JSON; success responses are binary image data. Check `res.ok` before choosing parse strategy (per research pitfall 6)
- `URL.revokeObjectURL` MUST be called on the previous URL before setting the new one to prevent memory leaks (per research pitfall 2)
  </action>
  <verify>Run `npm run build` (or `npx next build`). The page should compile with no TypeScript errors. The placeholder components render null so the page is valid. Confirm prompt-input.tsx has the TextareaAutosize import resolving correctly.</verify>
  <done>page.tsx orchestrates all state and renders PromptInput (functional), FilterControls (placeholder), and ResultDisplay (placeholder). handleGenerate sends POST to /api/generate with binary response handling. AbortController prevents duplicate requests. Object URL memory management implemented.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without TypeScript errors
2. `src/lib/constants.ts` exports ASPECT_RATIOS (8 items) and RESOLUTIONS (3 items) with correct values
3. `src/lib/types.ts` exports GenerateRequest and ErrorResponse
4. `src/components/prompt-input.tsx` renders an auto-expanding textarea with Cmd/Ctrl+Enter support
5. `src/app/page.tsx` imports and renders PromptInput, FilterControls, ResultDisplay
6. page.tsx contains handleGenerate with: fetch to /api/generate, AbortController, blob URL creation, previous URL revocation, error handling
7. `react-textarea-autosize` is in package.json dependencies
</verification>

<success_criteria>
- The app compiles and the page renders in the browser
- Typing in the textarea and pressing Generate (or Cmd/Ctrl+Enter) triggers a fetch to /api/generate
- The fetch sends prompt, aspectRatio, resolution, and mode in the request body
- Binary response is converted to a blob URL and stored in state
- Rapid clicks abort previous requests via AbortController
- Previous image blob URLs are revoked to prevent memory leaks
</success_criteria>

<output>
After completion, create `.planning/phases/02-text-to-image-generation/02-01-SUMMARY.md`
</output>
