---
phase: 05-output-actions-power-features
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/thinking-toggle.tsx
  - src/lib/types.ts
  - src/app/page.tsx
  - src/app/api/generate/route.ts
autonomous: true
requirements:
  - GEN-03

must_haves:
  truths:
    - "User can see a thinking level toggle with Fast and Quality options"
    - "User can switch between Low and High thinking levels before generating"
    - "The selected thinking level is sent to the API and forwarded to Gemini"
    - "The generation reflects the chosen quality/speed tradeoff"
  artifacts:
    - path: "src/components/thinking-toggle.tsx"
      provides: "Segmented control for thinking level selection"
      exports: ["ThinkingToggle"]
    - path: "src/lib/types.ts"
      provides: "ThinkingLevel type definition"
      contains: "ThinkingLevel"
    - path: "src/app/page.tsx"
      provides: "ThinkingLevel state management and API request integration"
      contains: "thinkingLevel"
    - path: "src/app/api/generate/route.ts"
      provides: "Server-side thinkingLevel validation and Gemini forwarding"
      contains: "thinkingConfig"
  key_links:
    - from: "src/app/page.tsx"
      to: "src/components/thinking-toggle.tsx"
      via: "renders ThinkingToggle with level state and onChange handler"
      pattern: "ThinkingToggle.*level"
    - from: "src/app/page.tsx"
      to: "src/app/api/generate/route.ts"
      via: "sends thinkingLevel in POST request body"
      pattern: "thinkingLevel"
    - from: "src/app/api/generate/route.ts"
      to: "Gemini API"
      via: "passes thinkingConfig.thinkingLevel in generateContent config"
      pattern: "thinkingConfig.*thinkingLevel"
---

<objective>
Add a thinking level toggle that lets the user trade generation speed for quality.

Purpose: Gemini 3 Pro Image supports two thinking levels — LOW (~30% faster) and HIGH (better quality). Exposing this control lets the user choose the tradeoff per generation.
Output: ThinkingToggle component, ThinkingLevel type, page state integration, and API route update.
</objective>

<execution_context>
@/Users/nusretozturk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nusretozturk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-output-actions-power-features/05-RESEARCH.md

# Reference existing files to understand current structure
@src/lib/types.ts
@src/app/page.tsx
@src/app/api/generate/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThinkingLevel type, toggle component, and wire state in page</name>
  <files>src/lib/types.ts, src/components/thinking-toggle.tsx, src/app/page.tsx</files>
  <action>
**1. Update `src/lib/types.ts`:**

Add type: `export type ThinkingLevel = "LOW" | "HIGH";`

If a generation request/params type exists, add `thinkingLevel?: ThinkingLevel` to it.

**2. Create `src/components/thinking-toggle.tsx`:**

Props: `{ level: ThinkingLevel; onChange: (level: ThinkingLevel) => void }`

Import `ThinkingLevel` from `@/lib/types`. Import `cn` from class utility (clsx/tailwind-merge).

Render a segmented control (two-button toggle group) placed alongside existing filter controls:
- Label: "Quality" (not "Thinking Level" — more intuitive for end users).
- Two options:
  - "Fast" → maps to `"LOW"`. Subtle description hint: "~30% quicker" (optional small text or tooltip).
  - "Quality" → maps to `"HIGH"`. This is the default.
- Active option gets a filled/highlighted style (use project's accent color pattern, e.g., `bg-primary text-primary-foreground`). Inactive option has a subtle hover state.
- Style: rounded segmented control with a shared border. Compact but touch-friendly (min 44px height). Use the same visual language as other filter controls (aspect ratio, resolution) for consistency.
- Wrap with a flex container: label on the left, toggle on the right (or label above on mobile).

**3. Update `src/app/page.tsx`:**

- Import `ThinkingLevel` from `@/lib/types`.
- Import `ThinkingToggle` from `@/components/thinking-toggle`.
- Add state: `const [thinkingLevel, setThinkingLevel] = useState<ThinkingLevel>("HIGH")` — default to HIGH (LOCKED: matches Gemini's model default for best quality out of the box).
- Render `<ThinkingToggle level={thinkingLevel} onChange={setThinkingLevel} />` in the filters/controls section, alongside existing aspect ratio and resolution controls.
- In the generate/submit handler, include `thinkingLevel` in the request body sent to `/api/generate`:
  ```
  body: JSON.stringify({ prompt, ..., thinkingLevel })
  ```
  </action>
  <verify>
- `src/lib/types.ts` contains `ThinkingLevel` type export
- `src/components/thinking-toggle.tsx` exists and exports `ThinkingToggle`
- `src/app/page.tsx` imports and renders `ThinkingToggle`, includes `thinkingLevel` in API request body
- `npm run build` completes without TypeScript errors
  </verify>
  <done>ThinkingLevel type exists. ThinkingToggle component renders a Fast/Quality segmented control. Page state defaults to HIGH and sends thinkingLevel in every generation request.</done>
</task>

<task type="auto">
  <name>Task 2: Update API route to validate and forward thinking level to Gemini</name>
  <files>src/app/api/generate/route.ts</files>
  <action>
**1. Update the request parsing in `src/app/api/generate/route.ts`:**

- Extract `thinkingLevel` from the parsed request body alongside existing fields (prompt, image, aspectRatio, resolution).
- Add server-side validation: only accept `"LOW"` or `"HIGH"`. If the value is missing, undefined, or any other string, default to `"HIGH"`. Do NOT return a validation error for missing thinkingLevel — it is optional and defaults gracefully.
- If using a zod schema for request validation, add: `thinkingLevel: z.enum(["LOW", "HIGH"]).optional().default("HIGH")`.
- If using manual validation, add: `const validatedLevel = thinkingLevel === "LOW" ? "LOW" : "HIGH";`

**2. Forward to Gemini in the `generateContent` config:**

Add `thinkingConfig` to the config object passed to `ai.models.generateContent`:

```typescript
config: {
  responseModalities: ["TEXT", "IMAGE"],
  imageConfig: { ... },
  thinkingConfig: {
    thinkingLevel: validatedLevel, // "LOW" or "HIGH"
  },
}
```

**3. Error handling for thinkingConfig:**

Wrap the Gemini call in existing error handling. If the API returns an error specifically about thinkingConfig (e.g., 400 with message about invalid thinking configuration), catch it, log the error, and retry WITHOUT the thinkingConfig parameter as a fallback. This handles the edge case where AI Studio API might not support thinkingLevel for image models (MEDIUM confidence from research). The retry-without-thinking fallback ensures generation still works.

Pattern:
```
try {
  // attempt with thinkingConfig
} catch (err) {
  if (isThinkingConfigError(err)) {
    // retry without thinkingConfig
  } else {
    throw err; // re-throw other errors
  }
}
```
  </action>
  <verify>
- `src/app/api/generate/route.ts` parses `thinkingLevel` from request body
- `src/app/api/generate/route.ts` validates thinkingLevel (only "LOW" or "HIGH", defaults to "HIGH")
- `src/app/api/generate/route.ts` passes `thinkingConfig.thinkingLevel` to Gemini
- `npm run build` completes without errors
- Sending a POST to `/api/generate` with `thinkingLevel: "LOW"` returns a generated image
- Sending a POST without `thinkingLevel` defaults to "HIGH" and returns a generated image
  </verify>
  <done>API route accepts thinkingLevel parameter, validates it server-side, forwards it to Gemini in thinkingConfig, and gracefully falls back if thinkingConfig is not supported by the API.</done>
</task>

</tasks>

<verification>
1. ThinkingToggle renders in the controls section with "Fast" and "Quality" options
2. Default selection is "Quality" (HIGH)
3. Clicking "Fast" switches to LOW, clicking "Quality" switches to HIGH
4. Generating an image with "Fast" selected sends `thinkingLevel: "LOW"` to the API
5. Generating an image with "Quality" selected sends `thinkingLevel: "HIGH"` to the API
6. API validates the thinkingLevel value and defaults to "HIGH" for invalid values
7. Generation succeeds with both LOW and HIGH thinking levels
8. `npm run build` passes with no errors
</verification>

<success_criteria>
- ThinkingToggle component visible alongside other filter controls
- Default is HIGH (Quality)
- Both LOW and HIGH produce successful generations
- Invalid thinkingLevel values are sanitized server-side to "HIGH"
- No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-output-actions-power-features/05-02-SUMMARY.md`
</output>
