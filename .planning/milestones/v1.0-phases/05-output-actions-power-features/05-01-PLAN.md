---
phase: 05-output-actions-power-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/image-utils.ts
  - src/components/fullscreen-viewer.tsx
  - src/components/image-actions.tsx
  - src/components/result-display.tsx
  - src/app/globals.css
autonomous: true
requirements:
  - OUT-02
  - OUT-03
  - OUT-04

must_haves:
  truths:
    - "User can click the generated image to open a fullscreen dark-overlay view"
    - "User can close fullscreen via X button, backdrop click, or Escape key"
    - "User can download the generated image as saimos-gen-{timestamp}.png"
    - "User can copy the generated image to clipboard with a single click"
  artifacts:
    - path: "src/lib/image-utils.ts"
      provides: "Image utility functions for download and clipboard"
      exports: ["downloadImage", "copyImageToClipboard", "isClipboardImageSupported"]
    - path: "src/components/fullscreen-viewer.tsx"
      provides: "Dialog-based fullscreen image overlay"
      exports: ["FullscreenViewer"]
    - path: "src/components/image-actions.tsx"
      provides: "Download and copy action buttons"
      exports: ["ImageActions"]
    - path: "src/components/result-display.tsx"
      provides: "Updated result display with click-to-fullscreen and action buttons"
  key_links:
    - from: "src/components/result-display.tsx"
      to: "src/components/fullscreen-viewer.tsx"
      via: "renders FullscreenViewer with isOpen state and image URL"
      pattern: "FullscreenViewer.*isOpen"
    - from: "src/components/image-actions.tsx"
      to: "src/lib/image-utils.ts"
      via: "calls downloadImage and copyImageToClipboard on button click"
      pattern: "(downloadImage|copyImageToClipboard)"
    - from: "src/components/result-display.tsx"
      to: "src/components/image-actions.tsx"
      via: "renders ImageActions below the generated image"
      pattern: "ImageActions"
---

<objective>
Give the user full control over generated images: fullscreen viewing, downloading as PNG, and copying to clipboard.

Purpose: The generated image is the core output of the app. Users need to view it unobstructed, save it locally, and copy it for use elsewhere. These are the three fundamental output actions.
Output: Fullscreen viewer component, image action buttons, image utility library, and integration into the existing result display.
</objective>

<execution_context>
@/Users/nusretozturk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nusretozturk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-output-actions-power-features/05-RESEARCH.md

# Reference existing components to understand current structure
@src/components/result-display.tsx
@src/app/globals.css
@src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create image utility library and fullscreen viewer component</name>
  <files>src/lib/image-utils.ts, src/components/fullscreen-viewer.tsx, src/app/globals.css</files>
  <action>
**1. Create `src/lib/image-utils.ts`** with three exported functions:

- `downloadImage(dataUrl: string): void` — Convert data URL to Blob using `fetch(dataUrl).then(r => r.blob())` (off main thread, avoids blocking for large images). Create temporary `<a>` element with `download="saimos-gen-${Date.now()}.png"` (LOCKED filename format). Set href to `URL.createObjectURL(blob)`, click programmatically, remove from DOM, revoke object URL.

- `copyImageToClipboard(dataUrl: string): Promise<boolean>` — Feature-detect `navigator.clipboard?.write`. Fetch dataUrl to get blob. Write to clipboard using `navigator.clipboard.write([new ClipboardItem({ "image/png": blob })])`. Return true on success, false on failure. Wrap in try/catch — return false if Clipboard API throws.

- `isClipboardImageSupported(): boolean` — Check: `typeof navigator !== "undefined"`, `navigator.clipboard?.write` exists, `typeof ClipboardItem !== "undefined"`. If `ClipboardItem.supports` exists as a function, also check `ClipboardItem.supports("image/png")`. Return false on server (SSR safety).

**2. Create `src/components/fullscreen-viewer.tsx`** using native HTML `<dialog>` element:

Props: `{ imageUrl: string; isOpen: boolean; onClose: () => void }`

- Use `useRef<HTMLDialogElement>` for the dialog element.
- `useEffect` to sync React `isOpen` state with native dialog: call `showModal()` when isOpen becomes true and dialog is not open; call `close()` when isOpen becomes false and dialog is open.
- `useEffect` to listen for the native `close` event on the dialog element — call `onClose()` to sync React state when user presses Escape (native behavior).
- `handleBackdropClick`: on `<dialog>` click, check `e.target === dialogRef.current` (clicked backdrop, not children) — if so, call `dialogRef.current.close()`.
- Render: `<dialog>` with classes for full viewport coverage (`fixed inset-0 m-0 h-screen w-screen max-h-none max-w-none bg-transparent p-0`). Inside: a flex container centered with padding. X close button in top-right corner using lucide-react `X` icon (white color, hover opacity). Image with `object-contain` (LOCKED: contain, not cover), `max-h-full max-w-full`.
- Subtle fade-in: add `opacity-0` by default on dialog, `dialog[open]` gets `opacity-100` with `transition-opacity duration-150`.

**3. Add dialog backdrop styles to `src/app/globals.css`:**

Add `dialog::backdrop { background: rgba(0, 0, 0, 0.85); }` (LOCKED: dark semi-transparent backdrop). Also add `dialog[open]` transition styles if not using Tailwind for the fade animation.
  </action>
  <verify>
- `src/lib/image-utils.ts` exists and exports `downloadImage`, `copyImageToClipboard`, `isClipboardImageSupported`
- `src/components/fullscreen-viewer.tsx` exists and exports `FullscreenViewer`
- `src/app/globals.css` contains `dialog::backdrop` rule with `rgba(0, 0, 0, 0.85)`
- `npm run build` completes without TypeScript errors
  </verify>
  <done>Image utility functions and fullscreen viewer component exist with correct exports, backdrop styled, and project builds cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Create image action buttons and integrate into result display</name>
  <files>src/components/image-actions.tsx, src/components/result-display.tsx</files>
  <action>
**1. Create `src/components/image-actions.tsx`:**

Props: `{ imageUrl: string }` (the base64 data URL of the generated image)

- Import `downloadImage`, `copyImageToClipboard`, `isClipboardImageSupported` from `@/lib/image-utils`.
- Import `Download`, `Copy`, `Check` icons from `lucide-react`.
- Import `toast` from `sonner`.
- Use `useState` for `copied` boolean (shows checkmark briefly after copy).
- Use `useState` or `useEffect` + `isClipboardImageSupported()` to determine if copy button should render (SSR-safe: default to false, check on mount).
- Render a horizontal row of buttons below the image:
  - **Download button**: Icon (`Download`) + text "Download". On click, call `downloadImage(imageUrl)`. Show toast on success: `toast.success("Download started")`.
  - **Copy button** (only if clipboard supported): Icon (`Copy` or `Check` when copied) + text "Copy". On click, call `copyImageToClipboard(imageUrl)`. If true: show `toast.success("Copied to clipboard")`, set `copied = true`, reset after 2 seconds via `setTimeout`. If false: show `toast.error("Failed to copy image")`.
- Style buttons with consistent sizing, rounded, hover states. Use the project's existing button patterns and Tailwind classes. Keep buttons compact but touch-friendly (min 44px tap target).
- LOCKED fallback: Hide copy button entirely when clipboard API is unavailable (not disabled — hidden).

**2. Update `src/components/result-display.tsx`:**

- Import `FullscreenViewer` from `@/components/fullscreen-viewer`.
- Import `ImageActions` from `@/components/image-actions`.
- Add local state: `const [isFullscreen, setIsFullscreen] = useState(false)`.
- Make the generated image clickable: wrap in a button or add `onClick={() => setIsFullscreen(true)}` with `cursor-pointer` class. Add visual hint that image is clickable (subtle hover effect like scale or brightness change).
- Render `<FullscreenViewer imageUrl={imageUrl} isOpen={isFullscreen} onClose={() => setIsFullscreen(false)} />` alongside the image.
- Render `<ImageActions imageUrl={imageUrl} />` below the generated image.
- Ensure the actions and fullscreen viewer only render when there IS a generated image (guard with conditional rendering on the image URL).
  </action>
  <verify>
- `src/components/image-actions.tsx` exists and exports `ImageActions`
- `src/components/result-display.tsx` imports and renders both `FullscreenViewer` and `ImageActions`
- `npm run build` completes without errors
- Visual check: generated image shows action buttons below it, clicking image opens fullscreen overlay
  </verify>
  <done>Image action buttons (download + conditional copy) render below the generated image. Clicking the image opens the fullscreen viewer. All three close methods (X, backdrop, Escape) work. Download triggers file save with correct filename format. Copy writes PNG to clipboard with toast feedback.</done>
</task>

</tasks>

<verification>
1. Click generated image → fullscreen overlay opens with dark backdrop (rgba(0,0,0,0.85)), image displayed at contain-fit
2. Press Escape in fullscreen → overlay closes
3. Click backdrop (not image) in fullscreen → overlay closes
4. Click X button in fullscreen → overlay closes
5. Click Download button → file download triggers with name matching `saimos-gen-{timestamp}.png`
6. Click Copy button → toast shows "Copied to clipboard", pasting in another app shows the image
7. On a browser without Clipboard API support → Copy button is hidden (not disabled)
8. `npm run build` passes with no errors
</verification>

<success_criteria>
- Fullscreen viewer opens/closes correctly via all three methods (X, backdrop, Escape)
- Download produces a PNG file named `saimos-gen-{timestamp}.png`
- Copy writes the image to clipboard and shows success toast
- Copy button hidden when browser doesn't support Clipboard API
- No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-output-actions-power-features/05-01-SUMMARY.md`
</output>
