---
phase: 03-image-to-image-editing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/image-utils.ts
  - src/lib/types.ts
  - src/components/image-upload.tsx
autonomous: true
requirements:
  - UX-05
  - GEN-02

must_haves:
  truths:
    - "User can click the upload zone to open a file picker and select an image"
    - "User can drag-and-drop an image file onto the upload zone"
    - "After uploading, user sees a thumbnail preview with file name, size, and a remove button"
    - "Selecting an invalid format (not JPEG/PNG/WebP) shows 'Supported formats: JPEG, PNG, WebP.' error before any API call"
    - "Selecting a file over 7MB shows 'Image must be under 7 MB.' error before any API call"
    - "Large images are resized client-side to fit within Vercel's 4.5MB request body limit"
  artifacts:
    - path: "src/lib/image-utils.ts"
      provides: "Image validation and resize utilities"
      exports: ["validateImageFile", "resizeImageIfNeeded", "readFileAsDataUrl", "VALID_IMAGE_TYPES", "MAX_IMAGE_SIZE_BYTES"]
    - path: "src/lib/types.ts"
      provides: "ImageUploadState type definition"
      contains: "ImageUploadState"
    - path: "src/components/image-upload.tsx"
      provides: "Upload component with file picker, drag-and-drop, and preview"
      exports: ["ImageUpload"]
      min_lines: 80
  key_links:
    - from: "src/components/image-upload.tsx"
      to: "src/lib/image-utils.ts"
      via: "import validateImageFile, resizeImageIfNeeded, readFileAsDataUrl"
      pattern: "import.*from.*image-utils"
    - from: "src/components/image-upload.tsx"
      to: "src/lib/types.ts"
      via: "import ImageUploadState type"
      pattern: "import.*ImageUploadState"
---

<objective>
Build the image upload component with file picker, drag-and-drop, thumbnail preview, client-side validation, and image resize utility.

Purpose: Provides the input mechanism for image-to-image editing. Users need a way to attach a reference image before generating. Client-side validation prevents wasted API calls and bandwidth. Client-side resize ensures images fit within Vercel's 4.5MB request body limit after base64 encoding.

Output: A reusable `ImageUpload` component, image validation/resize utilities, and the `ImageUploadState` type. Plan 03-02 will wire these into the page and generation flow.
</objective>

<execution_context>
@/Users/nusretozturk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nusretozturk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-image-to-image-editing/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create image validation utilities, resize helper, and type definitions</name>
  <files>src/lib/image-utils.ts, src/lib/types.ts</files>
  <action>
  **In `src/lib/types.ts`** -- add the `ImageUploadState` type (do NOT remove existing types from Phase 2):

  ```typescript
  export interface ImageUploadState {
    dataUrl: string;      // Full data URL: "data:image/png;base64,..."
    fileName: string;
    fileSize: number;     // Bytes
    mimeType: string;     // "image/jpeg" | "image/png" | "image/webp"
  }
  ```

  **In `src/lib/image-utils.ts`** -- create a new file with these exports:

  1. **Constants:**
     - `VALID_IMAGE_TYPES = ["image/jpeg", "image/png", "image/webp"] as const`
     - `MAX_IMAGE_SIZE_BYTES = 7 * 1024 * 1024` (7 MB)
     - `MAX_IMAGE_SIZE_LABEL = "7 MB"`
     - `MAX_DIMENSION = 2048` (pixels, longest edge for resize)
     - `COMPRESSION_QUALITY = 0.8` (JPEG quality for resize)

  2. **`validateImageFile(file: File): { type: string; message: string } | null`**
     - Check `file.type` against `VALID_IMAGE_TYPES`. If invalid: return `{ type: "invalid-format", message: "Supported formats: JPEG, PNG, WebP." }`.
     - Check `file.size` against `MAX_IMAGE_SIZE_BYTES`. If too large: return `{ type: "too-large", message: "Image must be under 7 MB." }`.
     - If valid: return `null`.
     - Check format FIRST (fast, no I/O), then size.

  3. **`resizeImageIfNeeded(file: File): Promise<File>`**
     - Creates an `Image` element from the file via `URL.createObjectURL`.
     - If both dimensions are <= `MAX_DIMENSION`, return the original file unchanged.
     - Otherwise, calculate new dimensions maintaining aspect ratio (scale to fit within MAX_DIMENSION on longest edge).
     - Draw to a canvas at the new dimensions. Export via `canvas.toBlob("image/jpeg", COMPRESSION_QUALITY)`.
     - Return a new `File` from the blob with the original name and `image/jpeg` type.
     - Revoke the object URL in both success and error paths to prevent memory leaks.

  4. **`readFileAsDataUrl(file: File): Promise<string>`**
     - Wraps `FileReader.readAsDataURL()` in a Promise.
     - Resolves with the data URL string on `onload`.
     - Rejects with an error on `onerror`.

  Follow the research code examples in 03-RESEARCH.md for implementation patterns. Do NOT install any new packages -- all functions use native browser APIs.
  </action>
  <verify>
  - `src/lib/image-utils.ts` exists and exports `validateImageFile`, `resizeImageIfNeeded`, `readFileAsDataUrl`, `VALID_IMAGE_TYPES`, `MAX_IMAGE_SIZE_BYTES`.
  - `src/lib/types.ts` contains `ImageUploadState` interface with `dataUrl`, `fileName`, `fileSize`, `mimeType` fields.
  - `npx tsc --noEmit` passes with no type errors in these files.
  </verify>
  <done>
  Image validation, resize, and file reading utilities are implemented with correct types. validateImageFile returns specific error objects for invalid format and oversized files. resizeImageIfNeeded scales images larger than 2048px on longest edge. readFileAsDataUrl wraps FileReader in a Promise.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build ImageUpload component with file picker, drag-and-drop, and preview</name>
  <files>src/components/image-upload.tsx</files>
  <action>
  Create `src/components/image-upload.tsx` exporting an `ImageUpload` component with the following behavior:

  **Props interface:**
  ```typescript
  interface ImageUploadProps {
    onImageSelect: (image: ImageUploadState) => void;
    onImageRemove: () => void;
    onError: (message: string) => void;
    uploadedImage: ImageUploadState | null;  // Controlled: parent owns the state
    disabled?: boolean;  // Disable during generation
  }
  ```

  **Shared file processing pipeline (`processFile`):**
  1. Call `validateImageFile(file)`. If error, call `onError(error.message)` and return.
  2. Call `resizeImageIfNeeded(file)` to handle Vercel body limit.
  3. Call `readFileAsDataUrl(resizedFile)` to get the data URL.
  4. Call `onImageSelect({ dataUrl, fileName: file.name, fileSize: file.size, mimeType: resizedFile.type })`.
  5. Wrap steps 2-4 in try/catch; on error call `onError("Failed to process image. Please try again.")`.

  **Input method 1: File picker**
  - Hidden `<input type="file" accept="image/jpeg,image/png,image/webp">` with a ref.
  - Clicking the upload zone triggers `fileInputRef.current?.click()`.
  - `onChange` handler gets `e.target.files?.[0]` and calls `processFile`.
  - Reset the input value after processing so the same file can be re-selected.

  **Input method 2: Drag-and-drop**
  - Use the drag counter pattern from research to prevent flickering on child elements:
    - `dragCounterRef = useRef(0)`
    - `dragenter`: increment counter, set `isDragActive = true`
    - `dragleave`: decrement counter, if 0 set `isDragActive = false`
    - `drop`: reset counter to 0, set `isDragActive = false`, process `e.dataTransfer.files?.[0]`
    - `dragover`: `e.preventDefault()` (required to allow drop)
  - All handlers call `e.preventDefault()` and `e.stopPropagation()`.

  **Visual states (Tailwind classes):**

  When `uploadedImage` is null (empty state):
  - Dashed border container (`border-2 border-dashed rounded-lg`).
  - Upload icon from lucide-react (`Upload` or `ImagePlus`).
  - Text: "Drop image, paste, or click" (primary), "JPEG, PNG, WebP -- up to 7 MB" (secondary, smaller text).
  - Cursor: `cursor-pointer`.
  - Drag-active: border becomes solid, background gets a subtle tint (`bg-accent/10` or similar using existing theme colors from Phase 4, or a neutral `bg-gray-50` if Phase 4 hasn't run yet).

  When `uploadedImage` is set (preview state):
  - Compact bar layout: small thumbnail (48-64px, `object-cover rounded`), file name (truncated with `truncate`), file size formatted (e.g., "2.4 MB"), and an X/remove button (lucide-react `X` icon).
  - Clicking the X calls `onImageRemove`.
  - The thumbnail uses `uploadedImage.dataUrl` as `src`.
  - File size formatting: bytes -> "X.X KB" or "X.X MB" as appropriate.

  When `disabled` is true:
  - Reduce opacity (`opacity-50`), disable pointer events (`pointer-events-none`).

  **Important implementation notes:**
  - Do NOT add a `paste` event listener in this component. Clipboard paste will be handled at the page level in Plan 03-02 (to avoid conflicts with the prompt textarea).
  - The component is controlled: `uploadedImage` comes from props, not internal state.
  - Import from `@/lib/image-utils` and `@/lib/types`.
  - Use existing Tailwind classes. Do not create custom CSS.
  </action>
  <verify>
  - `src/components/image-upload.tsx` exists and exports `ImageUpload`.
  - Component accepts `onImageSelect`, `onImageRemove`, `onError`, `uploadedImage`, and `disabled` props.
  - `npx tsc --noEmit` passes with no type errors.
  - The component renders a dashed-border upload zone in empty state and a thumbnail preview bar in uploaded state.
  - Drag-and-drop uses the counter pattern (search for `dragCounterRef` or similar).
  </verify>
  <done>
  ImageUpload component renders an interactive upload zone with file picker (click to browse), drag-and-drop (with flicker prevention), thumbnail preview with remove button, and visual feedback for drag-active state. Validation runs client-side before any file reading. Large images are resized before conversion to data URL.
  </done>
</task>

</tasks>

<verification>
1. Both `src/lib/image-utils.ts` and `src/components/image-upload.tsx` exist with correct exports.
2. `npx tsc --noEmit` passes -- no type errors across the project.
3. The ImageUpload component imports from `image-utils.ts` and `types.ts` (key links verified).
4. `validateImageFile` checks format first, then size, returning specific error messages.
5. `resizeImageIfNeeded` scales images exceeding 2048px on longest edge.
6. The upload zone has both empty state (dashed border + icon + text) and preview state (thumbnail + filename + size + remove button).
7. Drag-and-drop uses counter-based flicker prevention.
</verification>

<success_criteria>
- A developer can import `<ImageUpload />` into a page, pass the required props, and get a working upload zone with file picker and drag-and-drop.
- Selecting an invalid file format shows "Supported formats: JPEG, PNG, WebP." without any API call.
- Selecting a file over 7MB shows "Image must be under 7 MB." without any API call.
- After uploading a valid image, a thumbnail preview with file info and remove button appears.
- The component compiles without errors in the existing project setup.
</success_criteria>

<output>
After completion, create `.planning/phases/03-image-to-image-editing/03-01-SUMMARY.md`
</output>
