---
phase: 01-foundation-api-route
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - src/app/layout.tsx
  - src/app/page.tsx
  - src/app/globals.css
  - src/lib/gemini.ts
  - src/lib/schemas.ts
  - src/lib/constants.ts
  - src/lib/types.ts
  - src/lib/utils.ts
  - .env.local
  - .gitignore
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02

must_haves:
  truths:
    - "Next.js project runs with `npm run dev` without errors"
    - "Gemini SDK is initialized as a singleton with server-only API key"
    - "Zod schema validates generate request body with specific error messages"
    - "All shared constants (error messages, aspect ratios, resolutions) are defined and exported"
  artifacts:
    - path: "package.json"
      provides: "Project manifest with all dependencies"
      contains: "@google/genai"
    - path: "src/lib/gemini.ts"
      provides: "GoogleGenAI singleton and MODEL_ID constant"
      exports: ["ai", "MODEL_ID"]
    - path: "src/lib/schemas.ts"
      provides: "Zod request validation schema with PRD error messages"
      exports: ["generateRequestSchema", "GenerateRequest"]
    - path: "src/lib/constants.ts"
      provides: "Error messages, aspect ratios, resolutions"
      exports: ["ERROR_MESSAGES", "ASPECT_RATIOS", "RESOLUTIONS"]
    - path: "src/lib/types.ts"
      provides: "Shared TypeScript interfaces"
      exports: ["GenerateResponse", "ErrorResponse"]
    - path: "src/lib/utils.ts"
      provides: "cn() class name utility"
      exports: ["cn"]
  key_links:
    - from: "src/lib/gemini.ts"
      to: "process.env.GEMINI_API_KEY"
      via: "environment variable (no NEXT_PUBLIC_ prefix)"
      pattern: "process\\.env\\.GEMINI_API_KEY"
    - from: "src/lib/schemas.ts"
      to: "src/lib/constants.ts"
      via: "import for validation constants"
      pattern: "import.*constants"

user_setup:
  - service: google-ai-studio
    why: "Gemini API key required for image generation"
    env_vars:
      - name: GEMINI_API_KEY
        source: "Google AI Studio -> Get API key -> Create API key"
---

<objective>
Scaffold the Next.js 16 project with TypeScript, Tailwind CSS v4, and all shared libraries that the API route (Plan 01-02) and future UI phases depend on.

Purpose: Establish the project foundation -- dependencies, configuration, and reusable server-side modules -- so the API route can be built on a stable base.
Output: Running Next.js dev server, installed dependencies, shared lib/ modules ready for import.
</objective>

<execution_context>
@/Users/nusretozturk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nusretozturk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-api-route/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js project and install dependencies</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    .gitignore
    .env.local
    src/app/layout.tsx
    src/app/page.tsx
    src/app/globals.css
  </files>
  <action>
    1. Run `npx create-next-app@latest . --ts --tailwind --app --eslint --src-dir --import-alias "@/*"` in the project root. Accept defaults. If prompted about overwriting existing files, proceed (only .planning/ and docs exist).

    2. Install core dependencies:
       ```
       npm install @google/genai zod
       ```

    3. Install UI utilities:
       ```
       npm install clsx tailwind-merge
       ```

    4. Create `.env.local` with:
       ```
       GEMINI_API_KEY=your_api_key_here
       ```

    5. Verify `.gitignore` includes `.env*.local` (create-next-app adds this by default). If missing, add it.

    6. Update `next.config.ts` to be minimal:
       ```typescript
       import type { NextConfig } from "next";

       const nextConfig: NextConfig = {};

       export default nextConfig;
       ```

    7. Replace `src/app/page.tsx` with a minimal placeholder:
       ```tsx
       export default function Home() {
         return (
           <main className="flex min-h-screen items-center justify-center">
             <h1 className="text-2xl font-bold">Saimos Image Gen</h1>
           </main>
         );
       }
       ```

    8. Keep `src/app/globals.css` as generated by create-next-app (it will have `@import "tailwindcss"` for Tailwind v4).

    9. Keep `src/app/layout.tsx` as generated (metadata, font setup, globals import).

    Note: Do NOT prefix GEMINI_API_KEY with NEXT_PUBLIC_. It must remain server-only (INFRA-01).
  </action>
  <verify>
    Run `npm run dev` and confirm the dev server starts without errors. Visit http://localhost:3000 and confirm "Saimos Image Gen" renders. Run `npm run build` and confirm it builds successfully.
  </verify>
  <done>
    Next.js dev server starts, page renders, build succeeds. package.json contains @google/genai, zod, clsx, tailwind-merge. .env.local exists with GEMINI_API_KEY placeholder.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared library modules</name>
  <files>
    src/lib/gemini.ts
    src/lib/schemas.ts
    src/lib/constants.ts
    src/lib/types.ts
    src/lib/utils.ts
  </files>
  <action>
    Create the following files in `src/lib/`:

    **src/lib/gemini.ts** -- Gemini SDK singleton:
    ```typescript
    import { GoogleGenAI } from "@google/genai";

    if (!process.env.GEMINI_API_KEY) {
      throw new Error("GEMINI_API_KEY environment variable is required");
    }

    export const MODEL_ID = "gemini-3-pro-image-preview";

    export const ai = new GoogleGenAI({
      apiKey: process.env.GEMINI_API_KEY,
    });
    ```

    **src/lib/constants.ts** -- All shared constants:
    ```typescript
    export const ERROR_MESSAGES = {
      EMPTY_PROMPT: "Please enter a prompt.",
      PROMPT_TOO_LONG: "Prompt is too long. Please shorten it.",
      MISSING_IMAGE: "Please upload an image.",
      IMAGE_TOO_LARGE: "Image must be under 7 MB.",
      INVALID_IMAGE_FORMAT: "Supported formats: JPEG, PNG, WebP.",
      INVALID_ASPECT_RATIO: "Invalid aspect ratio.",
      INVALID_RESOLUTION: "Resolution must be 1K, 2K, or 4K.",
      GENERATION_FAILED: "Image generation failed. Please try again.",
      SAFETY_BLOCKED: "The request was blocked by content safety filters. Try rephrasing your prompt.",
      TIMEOUT: "Request timed out. Try a simpler prompt or lower resolution.",
      INVALID_BODY: "Invalid request body.",
    } as const;

    export const VALID_ASPECT_RATIOS = [
      "1:1", "3:2", "2:3", "4:3", "3:4", "16:9", "9:16", "21:9",
    ] as const;

    export const VALID_RESOLUTIONS = ["1K", "2K", "4K"] as const;
    export const VALID_MIME_TYPES = ["image/jpeg", "image/png", "image/webp"] as const;
    export const MAX_IMAGE_SIZE_BYTES = 7 * 1024 * 1024; // 7 MB
    export const MAX_PROMPT_LENGTH = 10_000;
    export const GEMINI_TIMEOUT_MS = 115_000; // 115s (5s buffer before Vercel's maxDuration)

    export const ASPECT_RATIOS = [
      { value: "1:1", label: "1:1" },
      { value: "3:2", label: "3:2" },
      { value: "2:3", label: "2:3" },
      { value: "4:3", label: "4:3" },
      { value: "3:4", label: "3:4" },
      { value: "16:9", label: "16:9" },
      { value: "9:16", label: "9:16" },
      { value: "21:9", label: "21:9" },
    ] as const;

    export const RESOLUTIONS = [
      { value: "1K", label: "1K", cost: "$0.134" },
      { value: "2K", label: "2K", cost: "$0.134" },
      { value: "4K", label: "4K", cost: "$0.24" },
    ] as const;
    ```

    **src/lib/schemas.ts** -- Zod validation schemas (import from constants for DRY):
    ```typescript
    import { z } from "zod";
    import {
      VALID_ASPECT_RATIOS,
      VALID_RESOLUTIONS,
      VALID_MIME_TYPES,
      ERROR_MESSAGES,
      MAX_PROMPT_LENGTH,
    } from "@/lib/constants";

    export const generateRequestSchema = z
      .object({
        prompt: z
          .string({ required_error: ERROR_MESSAGES.EMPTY_PROMPT })
          .min(1, ERROR_MESSAGES.EMPTY_PROMPT)
          .max(MAX_PROMPT_LENGTH, ERROR_MESSAGES.PROMPT_TOO_LONG),
        mode: z.enum(["text-to-image", "image-to-image"]).default("text-to-image"),
        aspectRatio: z
          .enum(VALID_ASPECT_RATIOS, {
            errorMap: () => ({ message: ERROR_MESSAGES.INVALID_ASPECT_RATIO }),
          })
          .default("1:1"),
        resolution: z
          .enum(VALID_RESOLUTIONS, {
            errorMap: () => ({ message: ERROR_MESSAGES.INVALID_RESOLUTION }),
          })
          .default("1K"),
        image: z.string().optional(),
        imageMimeType: z
          .enum(VALID_MIME_TYPES, {
            errorMap: () => ({ message: ERROR_MESSAGES.INVALID_IMAGE_FORMAT }),
          })
          .optional(),
      })
      .refine(
        (data) => {
          if (data.mode === "image-to-image") {
            return !!data.image && !!data.imageMimeType;
          }
          return true;
        },
        {
          message: ERROR_MESSAGES.MISSING_IMAGE,
          path: ["image"],
        }
      );

    export type GenerateRequest = z.infer<typeof generateRequestSchema>;
    ```

    **src/lib/types.ts** -- Shared TypeScript interfaces:
    ```typescript
    export interface ErrorResponse {
      error: string;
    }

    export interface GenerateSuccessMetadata {
      textResponse?: string;
      mimeType: string;
      contentLength: number;
    }
    ```

    **src/lib/utils.ts** -- Class name utility:
    ```typescript
    import { clsx, type ClassValue } from "clsx";
    import { twMerge } from "tailwind-merge";

    export function cn(...inputs: ClassValue[]) {
      return twMerge(clsx(inputs));
    }
    ```

    Ensure all files use the `@/*` import alias (e.g., `import { ... } from "@/lib/constants"`).
  </action>
  <verify>
    Run `npm run build` to confirm all lib files compile without TypeScript errors. Verify the build output shows no warnings about the lib files.
  </verify>
  <done>
    All 5 lib files exist, compile without errors, and export their declared types/values. Build succeeds. gemini.ts reads from process.env.GEMINI_API_KEY (server-only). schemas.ts imports from constants.ts and exports generateRequestSchema with PRD-matching error messages.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. `npm run build` succeeds
3. `grep -r "GEMINI" src/lib/gemini.ts` shows `process.env.GEMINI_API_KEY` (no NEXT_PUBLIC_ prefix)
4. All lib files exist: gemini.ts, schemas.ts, constants.ts, types.ts, utils.ts
5. package.json lists @google/genai, zod, clsx, tailwind-merge as dependencies
</verification>

<success_criteria>
- Project scaffolded with Next.js 16, TypeScript, Tailwind CSS v4, App Router
- All dependencies installed (@google/genai, zod, clsx, tailwind-merge)
- Gemini SDK singleton configured server-only (INFRA-01)
- Zod validation schema matches PRD error messages (INFRA-02)
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-api-route/01-01-SUMMARY.md`
</output>
